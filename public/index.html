<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>实时协作编辑器</title>
  <!-- 只保留一种加载方式 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
  <style>
    body { font-family: Arial; max-width: 800px; margin: 0 auto; }
    #editor { height: 60vh; border: 1px solid #ddd; }
    #online-users { background: #f5f5f5; padding: 10px; }
  </style>
</head>
<body>
  <div id="auth">
    <h2>登录</h2>
    <input type="text" id="username" placeholder="用户名">
    <input type="password" id="password" placeholder="密码">
    <button id="login-btn">登录</button> <!-- 改为事件监听方式 -->
  </div>

  <div id="editor-container" style="display: none;">
    <div id="online-users">在线用户: 加载中...</div>
    <div id="editor"></div>
    <div id="status"></div>
  </div>

<script>
// 全局初始化（确保在最顶部）
const supabase = createClient(
  "https://lonfebjqggtocthftsck.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9"
);

let editor;

// DOM加载完成后执行
document.addEventListener('DOMContentLoaded', () => {
  // 改用事件监听替代onclick
  document.getElementById('login-btn').addEventListener('click', login);
});

async function login() {
  const username = document.getElementById('username').value;
  const password = document.getElementById('password').value;
  
  try {
    const { error } = await supabase.auth.signInWithPassword({
      email: `${username}@codework.com`,
      password: password
    });

    if (error) throw error;
    
    document.getElementById('auth').style.display = 'none';
    document.getElementById('editor-container').style.display = 'block';
    initEditor();
  } catch (error) {
    alert("登录失败: " + error.message);
    console.error(error);
  }
}

function initEditor() {
  editor = CodeMirror(document.getElementById('editor'), {
    mode: 'htmlmixed',
    lineNumbers: true,
    value: '<h1>开始编辑...</h1>'
  });

  // 实时同步
  const channel = supabase.channel('doc-updates')
    .on('postgres_changes', {
      event: 'UPDATE',
      schema: 'public',
      table: 'documents',
      filter: 'id=eq.shared-doc'
    }, (payload) => {
      if (payload.new.last_editor !== supabase.auth.user()?.id) {
        editor.setValue(payload.new.content);
      }
    })
    .subscribe();

  // 保存逻辑
  editor.on('change', () => {
    debounceSave();
  });
}

// 防抖保存
let saveTimeout;
function debounceSave() {
  clearTimeout(saveTimeout);
  saveTimeout = setTimeout(async () => {
    try {
      await supabase.from('documents').upsert({
        id: 'shared-doc',
        content: editor.getValue(),
        last_editor: supabase.auth.user()?.id
      });
    } catch (error) {
      console.error('保存失败:', error);
    }
  }, 1000);
}
</script>
</body>
</html>